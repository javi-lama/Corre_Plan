<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Corre Plan: Herramienta para planificar tareas hospitalarias de manera r√°pida y organizada.">
  <meta name="author" content="Javier A. Lama Agurto">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Corre Plan - Home</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #ccc;
    }
    .branding {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .branding h1 {
      margin: 0;
    }
    .branding img {
      height: 100%;
    }
    .inspirational-text {
      font-style: italic;
      font-size: 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #f9f9f9;
    }
    .date-nav {
      font-size: 16px;
    }
    .config-button {
      background: #ddd;
      border: none;
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
    }
    .nav-tabs {
      display: flex;
      overflow-x: auto;
      padding: 10px 20px;
      background: #e8f6f7;
      gap: 10px;
    }
    .nav-tab {
      padding: 14px 18px;
      border-radius: 20px;
      background-color: #00bcd4;
      color: white;
      font-weight: bold;
      white-space: nowrap;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 16px;
    }
    .nav-tab.active {
      background-color: white;
      color: #00bcd4;
      border: 2px solid #00bcd4;
    }
    .task-checkboxes {
      display: flex;
      gap: 4px;
      align-items: flex-start;
      justify-content: flex-end;
      margin-top: 0;
    }
    .delete-task {
      cursor: pointer;
      margin-left: 8px;
      font-size: 16px;
      color: #c62828;
      transition: transform 0.2s;
    }
    .delete-task:hover {
      transform: scale(1.2);
    }
    .edit-task {
      cursor: pointer;
      margin-left: 8px;
      font-size: 16px;
      color: #1976d2;
      transition: transform 0.2s;
    }
    .edit-task:hover {
      transform: scale(1.2);
    }
    .completed-task {
      background-color: #e0f7e9;
      border-radius: 10px;
      padding: 4px 6px;
    }

    /* Nueva clase para alinear tareas y checkboxes en la vista cama */
    #cama-view .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }

    /* Bot√≥n eliminar tarea en vista cama individual */
    .delete-btn-cama {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #c62828;
      margin-left: 8px;
      transition: transform 0.2s;
      padding: 0 2px;
    }
    .delete-btn-cama:hover {
      transform: scale(1.2);
      background: #ffeaea;
      border-radius: 6px;
    }

    /* Mejorado bot√≥n submit */
    button[type="submit"] {
      width: 100%;
      background: #00bcd4;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    button[type="submit"]:hover {
      background-color: #0097a7;
      transform: translateY(-1px);
    }

    button[type="submit"]:active {
      background-color: #00838f;
      transform: translateY(1px);
    }
  </style>
</head>
<body>
  <noscript>
    <div style="background: #ffcaca; padding: 10px; border: 1px solid red; text-align: center;">
      ‚ö†Ô∏è Esta p√°gina necesita JavaScript activado para funcionar correctamente.
    </div>
  </noscript>
  <header>
    <div class="branding">
      <h1>¬°Corre Plan!</h1>
      <div style="height: 40px; border-left: 2px solid #ccc; margin: 0 15px;"></div>
      <img src="https://emedicina.upch.edu.pe/profesionalismo/img/logo.png" alt="Cayetano Logo" style="height: 40px;" />
    </div>
    <button class="config-button">‚öôÔ∏è Configuraci√≥n</button>
  </header>

  <div class="top-bar">
    <div class="inspirational-text">"Divide y vencer√°s"</div>
    <div class="date-nav">
      <button>‚¨ÖÔ∏è</button>
      <span class="date-display"></span>
      <button>‚û°Ô∏è</button>
    </div>
  </div>

  <nav class="nav-tabs">
    <button class="nav-tab tab-button active bed-button" data-bed="Acumulado" id="acumulado-button" data-cama-id="acumulado">Acumulado</button>
    <button class="nav-tab tab-button" data-cama-id="1">CAMA 1</button>
    <button class="nav-tab tab-button" data-cama-id="2">CAMA 2</button>
    <button class="nav-tab tab-button" data-cama-id="3">CAMA 3</button>
    <button class="nav-tab tab-button" data-cama-id="4">CAMA 4</button>
    <button class="nav-tab tab-button" data-cama-id="5">CAMA 5</button>
    <button class="nav-tab tab-button" data-cama-id="6">CAMA 6</button>
    <button class="nav-tab tab-button" data-cama-id="7">CAMA 7</button>
    <button class="nav-tab tab-button" data-cama-id="8">CAMA 8</button>
    <button class="nav-tab tab-button" data-cama-id="9">CAMA 9</button>
    <button class="nav-tab tab-button" data-cama-id="10">CAMA 10</button>
    <button class="nav-tab tab-button" data-cama-id="11">CAMA 11</button>
    <button class="nav-tab tab-button" data-cama-id="12">CAMA 12</button>
    <button class="nav-tab tab-button" data-cama-id="13">CAMA 13</button>
    <button class="nav-tab tab-button" data-cama-id="14">CAMA 14</button>
    <button class="nav-tab tab-button" data-cama-id="15">CAMA 15</button>
    <button class="nav-tab tab-button" data-cama-id="16">CAMA 16</button>
    <button class="nav-tab tab-button" data-cama-id="17">CAMA 17</button>
    <button class="nav-tab tab-button" data-cama-id="18">CAMA 18</button>
    <button class="nav-tab tab-button" data-cama-id="19">CAMA 19</button>
    <button class="nav-tab tab-button" data-cama-id="20">CAMA 20</button>
  </nav>

  <main style="display: flex; padding: 20px; gap: 20px;">
    <!-- Panel de tareas acumuladas envuelto en #acumulado-view -->
    <div id="acumulado-view" style="flex: 2.33;">
      <section style="background: #f0f4ff; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; align-items: center;">
        <h2 class="plan-title"></h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <div>
            <h3><span data-cama-id="1">CAMA 1</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="2">CAMA 2</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="3">CAMA 3</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="4">CAMA 4</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="5">CAMA 5</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="6">CAMA 6</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="7">CAMA 7</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="8">CAMA 8</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="9">CAMA 9</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="10">CAMA 10</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="11">CAMA 11</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="12">CAMA 12</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="13">CAMA 13</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="14">CAMA 14</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="15">CAMA 15</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="16">CAMA 16</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="17">CAMA 17</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="18">CAMA 18</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="19">CAMA 19</span></h3>
            <ul></ul>
          </div>
          <div>
            <h3><span data-cama-id="20">CAMA 20</span></h3>
            <ul></ul>
          </div>
        </div>
      </section>
    </div>
    <!-- Nueva vista individual de cama -->
    <div id="cama-view" style="display: none; flex: 2.33;">
      <div class="bed-panel cama-panel" style="background: #f0f4ff; padding: 20px; border-radius: 10px;" data-bed="">
        <h2 class="bed-panel-title" id="cama-view-title"></h2>
        <!-- Aqu√≠ se construir√° din√°micamente la vista de cama -->
        <div class="bed-panel-container" style="display: flex; gap: 20px;">
          <!-- Columna izquierda: Cajas cl√≠nicas -->
          <div class="clinical-boxes" style="flex: 1;">
            <div>
              <h3>üìù Resumen de Historia Cl√≠nica</h3>
              <textarea class="clinical-textarea" data-type="history" rows="8" style="width: 100%; resize: vertical;"></textarea>
            </div>
            <div>
              <h3>üß† Diagn√≥sticos</h3>
              <textarea class="clinical-textarea" data-type="diagnosis" rows="8" style="width: 100%; resize: vertical;"></textarea>
            </div>
            <div>
              <h3>üìà Evoluci√≥n & Resultados</h3>
              <textarea class="clinical-textarea" data-type="evolution" rows="8" style="width: 100%; resize: vertical;"></textarea>
            </div>
          </div>

          <!-- Columna centro: Tareas filtradas por cama + bot√≥n borrar todas las tareas de esta cama -->
          <div style="flex: 1; display: flex; flex-direction: column;">
            <h3>Tareas para esta cama</h3>
            <div id="filtered-task-container"></div>
            <!-- Bot√≥n borrar todas las tareas de esta cama (solo visible en vista cama) -->
            <div id="delete-bed-tasks-container" style="width: 100%; margin-top: 12px;"></div>
          </div>
          <!-- Columna derecha vac√≠a (opcional para layout) -->
          <div class="right-column" style="flex: 1;"></div>
  <script>
    // --- NUEVO: Bot√≥n borrar todas las tareas de una cama espec√≠fica en la vista cama ---
    function renderDeleteBedTasksButton() {
      // Determinar si estamos en la vista de cama individual
      const camaView = document.getElementById('cama-view');
      const isBedView = camaView && camaView.style.display !== 'none';
      // El contenedor bajo "A√±adir tarea" de la columna central
      const deleteBedTasksContainer = camaView ? camaView.querySelector('#delete-bed-tasks-container') : null;
      // Limpiar cualquier bot√≥n previo
      if (deleteBedTasksContainer) deleteBedTasksContainer.innerHTML = '';
      if (isBedView && deleteBedTasksContainer) {
        // Crear el bot√≥n
        const deleteBedTasksBtn = document.createElement("button");
        deleteBedTasksBtn.classList.add("delete-all-button");
        deleteBedTasksBtn.style.backgroundColor = "#dc3545"; // rojo
        deleteBedTasksBtn.style.color = "white";
        deleteBedTasksBtn.style.marginTop = "10px";
        deleteBedTasksBtn.style.padding = "10px 14px";
        deleteBedTasksBtn.style.borderRadius = "8px";
        deleteBedTasksBtn.style.border = "none";
        deleteBedTasksBtn.style.fontSize = "16px";
        deleteBedTasksBtn.style.cursor = "pointer";
        deleteBedTasksBtn.textContent = "üóëÔ∏è Borrar TODAS las tareas de esta cama";
        deleteBedTasksBtn.addEventListener("click", () => {
          const confirmacion = confirm("¬øEst√°s seguro de que deseas borrar TODAS las tareas de esta cama?");
          if (!confirmacion) return;
          // Obtener el n√∫mero de cama actual (puede estar en currentCama, camaSeleccionadaActual o el atributo data-bed)
          let camaActual = null;
          if (typeof camaSeleccionadaActual !== "undefined" && camaSeleccionadaActual) {
            camaActual = camaSeleccionadaActual;
          } else if (typeof currentCama !== "undefined" && currentCama) {
            camaActual = currentCama;
          } else {
            // Fallback: intentar leer de panel
            const camaPanel = document.querySelector('.bed-panel.cama-panel');
            if (camaPanel) {
              // nombreCama = camaPanel.getAttribute('data-bed'), pero necesitamos el n√∫mero
              const nombreCama = camaPanel.getAttribute('data-bed') || "";
              const match = nombreCama.match(/\d+/);
              if (match) camaActual = match[0];
            }
          }
          if (!camaActual) {
            alert("No se pudo determinar la cama actual.");
            return;
          }
          // Leer nombres personalizados
          let tareasData = JSON.parse(localStorage.getItem('tareas')) || {};
          const nombresCamas = tareasData['_nombresCamas'] || {};
          let nombreCama = nombresCamas[camaActual] || `CAMA ${camaActual}`;
          // Eliminar las tareas de esa cama
          if (tareasData[nombreCama]) {
            delete tareasData[nombreCama];
          }
          // Guardar
          localStorage.setItem('tareas', JSON.stringify(tareasData));
          // Recargar vistas
          if (typeof renderTareas === "function") renderTareas();
          if (typeof renderFilteredTasks === "function") renderFilteredTasks(camaActual);
        });
        deleteBedTasksContainer.appendChild(deleteBedTasksBtn);
      }
    }
    // Llamar a la funci√≥n al cargar y al cambiar de pesta√±a
    window.addEventListener('DOMContentLoaded', renderDeleteBedTasksButton);
    // Tambi√©n al hacer click en tabs (despu√©s de cambiar de pesta√±a)
    document.addEventListener('click', function(e) {
      if (e.target.classList && e.target.classList.contains('tab-button')) {
        setTimeout(renderDeleteBedTasksButton, 10);
      }
    });
  </script>
  <script>
    // Renderiza las tareas filtradas por cama en la vista individual
    function renderFilteredTasks(camaNumber) {
      const taskContainer = document.getElementById('filtered-task-container');
      if (!taskContainer) return;
      taskContainer.innerHTML = ''; // Limpiar tareas anteriores

      // Recuperar tareas desde localStorage
      let tareasData = JSON.parse(localStorage.getItem('tareas')) || {};
      // Nombres personalizados
      const nombresCamas = tareasData['_nombresCamas'] || {};
      let nombreCama = nombresCamas[camaNumber] || `CAMA ${camaNumber}`;

      // Buscar tareas para esa cama
      const tareas = tareasData[nombreCama] || [];

      tareas.forEach((tarea, index) => {
        // Crear wrapper con la clase task-item para aplicar el estilo flex
        const tareaDiv = document.createElement('div');
        tareaDiv.classList.add('task-item', 'filtered-task');

        // Determinar n√∫mero de checkboxes
        const numChecks = tarea.checks?.length || 0;

        // Crear el span del texto
        const tareaTexto = document.createElement('span');
        tareaTexto.textContent = (tarea.texto || tarea.text || '');

        // Crear el contenedor de checkboxes interactivos
        const checkboxContainer = document.createElement('div');
        checkboxContainer.className = 'task-checkboxes';
        for (let i = 0; i < numChecks; i++) {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = tarea.checks[i];
          // Usar atributos data para identificar la tarea y el √≠ndice del checkbox
          checkbox.setAttribute('data-bed', camaNumber);
          checkbox.setAttribute('data-index', index);
          checkbox.setAttribute('data-check-idx', i);
          // NUEVO: para listeners globales
          checkbox.classList.add('task-checkbox');
          checkbox.setAttribute('data-id', index);
          checkbox.setAttribute('data-type', i);
          // No disabled: interactivo
          checkboxContainer.appendChild(checkbox);
        }

        // Crear el bot√≥n eliminar tarea para cama
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn-cama';
        deleteBtn.title = 'Eliminar tarea';
        deleteBtn.innerHTML = 'üóëÔ∏è';

        // A√±adir primero el texto, luego los checkboxes, luego el bot√≥n eliminar
        tareaDiv.appendChild(tareaTexto);
        tareaDiv.appendChild(checkboxContainer);
        tareaDiv.appendChild(deleteBtn);

        // L√≥gica visual: aplicar fondo y emoji solo si todos los checks est√°n marcados
        updateTaskVisualsInBedView(tareaDiv, {
          text: tarea.texto || tarea.text || '',
          checks: tarea.checks
        });

        // Evento para eliminar tarea en la vista cama (con confirmaci√≥n)
        deleteBtn.addEventListener("click", () => {
          const confirmDelete = confirm("¬øEst√°s seguro de que deseas eliminar esta tarea?");
          if (confirmDelete) {
              tareas.splice(index, 1);
              tareasData[nombreCama] = tareas;
              localStorage.setItem("tareas", JSON.stringify(tareasData));
              renderAccumulatedTasks && renderAccumulatedTasks();
              renderFilteredTasks(camaNumber);
          }
        });

        taskContainer.appendChild(tareaDiv);
      });

      // --- NUEVO: Asignar listeners a los checkboxes de la vista filtrada ---
      const checkboxes = document.querySelectorAll('.filtered-task .task-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          const taskId = this.getAttribute('data-id');
          const checkboxType = this.getAttribute('data-type');
          updateCheckboxState(taskId, checkboxType, this.checked);
          renderAccumulatedTasks && renderAccumulatedTasks();
          renderFilteredTasks(currentBedNumber || camaNumber);
        });
      });
    }
    // --- NUEVO: Funci√≥n para actualizar el estado de un checkbox de tarea filtrada ---
    function updateCheckboxState(taskId, checkboxType, checked) {
      // taskId: √≠ndice de la tarea, checkboxType: √≠ndice del checkbox
      // currentBedNumber puede no estar definido, usar camaSeleccionadaActual si es necesario
      const camaNumber = currentBedNumber || camaSeleccionadaActual;
      if (!camaNumber) return;
      let tareasData = JSON.parse(localStorage.getItem('tareas')) || {};
      const nombresCamas = tareasData['_nombresCamas'] || {};
      let nombreCama = nombresCamas[camaNumber] || `CAMA ${camaNumber}`;
      const tareas = tareasData[nombreCama] || [];
      const tareaIdx = parseInt(taskId);
      const checkIdx = parseInt(checkboxType);
      if (
        Array.isArray(tareas) &&
        tareas[tareaIdx] &&
        Array.isArray(tareas[tareaIdx].checks)
      ) {
        tareas[tareaIdx].checks[checkIdx] = checked;
        tareasData[nombreCama] = tareas;
        localStorage.setItem('tareas', JSON.stringify(tareasData));
      }
    }

    // --- NUEVO: Funci√≥n para renderizar tareas acumuladas (llamada en el listener) ---
    function renderAccumulatedTasks() {
      renderTareas && renderTareas();
    }

    // Corrige el bug visual del fondo verde y emoji en la vista de cama individual
    function updateTaskVisualsInBedView(taskElement, taskData) {
      const isCompleted = taskData.checks.every(Boolean);

      // Actualizar fondo verde
      if (isCompleted) {
        taskElement.classList.add("completed");
        taskElement.style.backgroundColor = "#d4edda";
      } else {
        taskElement.classList.remove("completed");
        taskElement.style.backgroundColor = "";
      }

      // Eliminar cualquier emoji antiguo
      let textOnly = taskData.text.replace(/‚úÖ/g, "").trim();

      // Volver a colocar el texto limpio
      // taskElement.childNodes[0] es el <span> con el texto
      if (taskElement.childNodes[0]) {
        taskElement.childNodes[0].textContent = textOnly;
        // A√±adir emoji si est√° completado
        if (isCompleted) {
          taskElement.childNodes[0].textContent += " ‚úÖ";
        }
      }
    }

    // --- EVENTO PARA CHECKBOXES INTERACTIVOS EN VISTA CAMA ---
    // Se asegura que localStorage y la UI se mantengan sincronizadas
    document.getElementById('cama-view').addEventListener('change', function (e) {
      if (
        e.target.matches("input[type='checkbox'][data-bed][data-index][data-check-idx]")
      ) {
        // Obtener identificadores
        const camaNumber = e.target.getAttribute('data-bed');
        const tareaIdx = parseInt(e.target.getAttribute('data-index'));
        const checkIdx = parseInt(e.target.getAttribute('data-check-idx'));
        // Leer datos actuales
        let tareasData = JSON.parse(localStorage.getItem('tareas')) || {};
        const nombresCamas = tareasData['_nombresCamas'] || {};
        let nombreCama = nombresCamas[camaNumber] || `CAMA ${camaNumber}`;
        const tareas = tareasData[nombreCama] || [];
        // Actualizar el valor del check correspondiente
        if (
          Array.isArray(tareas) &&
          tareas[tareaIdx] &&
          Array.isArray(tareas[tareaIdx].checks)
        ) {
          tareas[tareaIdx].checks[checkIdx] = e.target.checked;
          // Guardar y volver a renderizar ambas vistas
          tareasData[nombreCama] = tareas;
          localStorage.setItem('tareas', JSON.stringify(tareasData));
          // Vuelve a renderizar panel acumulado y cama activa
          renderTareas();
          renderFilteredTasks(camaNumber);
        }
      }
    });
  </script>
        </div>
      </div>
    </div>
    <!-- Columna de a√±adir tarea -->
    <aside style="flex: 0.67; background: linear-gradient(to bottom, #c6ffe2, #c6e9ff); padding: 20px; border-radius: 10px; display: flex; flex-direction: column; align-items: center;">
      <h2>A√±adir tarea</h2>
      <form style="width: 100%;">
        <label for="cama">Cama:</label><br>
        <select id="cama" name="cama" style="width: 100%; max-width: 100%; margin-bottom: 10px;">
          <option value="">Seleccione</option>
          <option value="1">CAMA 1</option>
          <option value="2">CAMA 2</option>
          <option value="3">CAMA 3</option>
          <option value="4">CAMA 4</option>
          <option value="5">CAMA 5</option>
          <option value="6">CAMA 6</option>
          <option value="7">CAMA 7</option>
          <option value="8">CAMA 8</option>
          <option value="9">CAMA 9</option>
          <option value="10">CAMA 10</option>
          <option value="11">CAMA 11</option>
          <option value="12">CAMA 12</option>
          <option value="13">CAMA 13</option>
          <option value="14">CAMA 14</option>
          <option value="15">CAMA 15</option>
          <option value="16">CAMA 16</option>
          <option value="17">CAMA 17</option>
          <option value="18">CAMA 18</option>
          <option value="19">CAMA 19</option>
          <option value="20">CAMA 20</option>
        </select><br>

        <label>Imagen:</label><br>
        <input type="text" id="imagen" name="imagen" style="width: 100%; max-width: 100%; margin-bottom: 10px;" /><br>

        <label>Lab:</label><br>
        <input type="text" id="lab" name="lab" style="width: 100%; max-width: 100%; margin-bottom: 10px;" /><br>

        <label>Interconsulta:</label><br>
        <input type="text" id="interconsulta" name="interconsulta" style="width: 100%; max-width: 100%; margin-bottom: 10px;" /><br>

        <label for="accion">Acci√≥n:</label><br>
        <select id="accion" name="accion" style="width: 100%; max-width: 100%; margin-bottom: 10px;">
          <option value="">Seleccione</option>
          <option value="evolucionar">Evolucionar</option>
          <option value="alta">Alta</option>
          <option value="hc">Hacer HC</option>
        </select><br>

        <label>Otro:</label><br>
        <textarea id="otro" name="otro" rows="3" style="width: 100%; max-width: 100%; margin-bottom: 10px;"></textarea><br>

        <label for="alerta">Alerta temporal:</label><br>
        <select id="alerta" style="width: 100%; max-width: 100%; margin-bottom: 5px;">
          <option value="">Seleccione</option>
          <option value="1">Cada 1 d√≠a</option>
          <option value="2">Cada 2 d√≠as</option>
          <option value="3">Cada 3 d√≠as</option>
          <option value="5">Cada 5 d√≠as</option>
          <option value="7">Cada 7 d√≠as</option>
        </select>

        <button id="addTaskButton" type="submit">‚ûï A√±adir</button>
      </form>
      <!-- Bot√≥n global de borrado de tareas (solo visible en vista acumulada, renderizado por JS) -->
      <div id="delete-all-container" style="width: 100%; margin-top: 12px;"></div>
    </aside>
  </main>
  <section style="background: #eef; padding: 15px 30px; margin: 0 20px 20px 20px; border-radius: 10px; font-size: 15px;">
    <strong>‚ÑπÔ∏è ¬øC√≥mo usar esta herramienta?</strong><br>
    1. Selecciona una cama y escribe una tarea.<br>
    2. Marca los checks cuando est√©n completados.<br>
    3. Usa los √≠conos ‚úèÔ∏è y üóëÔ∏è para editar o borrar.<br>
    4. Las tareas se guardan autom√°ticamente. ‚úÖ
    <br><br>
    üõèÔ∏è Puedes editar el n√∫mero de cualquier cama haciendo doble clic sobre su nombre, ya sea en el men√∫ superior o en el encabezado del plan acumulado. Esto actualizar√° autom√°ticamente todas las referencias a esa cama, incluyendo el men√∫ desplegable de tareas.
  </section>

  <script>
    // Global variable to track currentCama and camaSeleccionadaActual for dropdown logic
    let currentCama = null;
    // Holds the currently active bed number when viewing a specific bed window
    let camaSeleccionadaActual = null;
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = today.toLocaleDateString('es-PE', options);
    document.querySelectorAll('.date-display').forEach(el => {
      el.innerHTML = `<strong>${formattedDate}</strong>`;
    });
    document.querySelectorAll('.plan-title').forEach(el => {
      el.innerText = `Plan acumulado ‚Ä¢ ${today.toLocaleDateString('es-PE')}`;
    });
  </script>
  <script>
    const accionSelect = document.getElementById('accion');
    const fieldsToDisable = ['imagen', 'lab', 'interconsulta', 'otro'];
    const alertaDropdown = document.getElementById('alerta');
    const usarAlertaDropdown = document.createElement('select');
    usarAlertaDropdown.id = 'usar-alerta';
    usarAlertaDropdown.style.width = '100%';
    usarAlertaDropdown.style.marginBottom = '10px';
    usarAlertaDropdown.innerHTML = `
      <option value="si">S√≠</option>
      <option value="no" selected>No</option>
    `;
    alertaDropdown.before(usarAlertaDropdown);
    alertaDropdown.style.display = 'none';

    usarAlertaDropdown.addEventListener('change', () => {
      alertaDropdown.style.display = usarAlertaDropdown.value === 'si' ? 'block' : 'none';
    });

    accionSelect.addEventListener('change', () => {
      const disable = accionSelect.value !== '';
      fieldsToDisable.forEach(id => {
        const field = document.querySelector(`[name="${id}"]`) || document.getElementById(id);
        if (field) field.disabled = disable;
      });

      const alertaDisabled = accionSelect.value === 'alta' || accionSelect.value === 'hc';
      if (alertaDisabled) {
        usarAlertaDropdown.value = 'no';
        usarAlertaDropdown.dispatchEvent(new Event('change'));
        usarAlertaDropdown.disabled = true;
        alertaDropdown.disabled = true;
      } else {
        usarAlertaDropdown.disabled = false;
        alertaDropdown.disabled = false;
      }
    });
  </script>
<script>
  document.querySelectorAll('.delete-task').forEach(btn => {
    btn.addEventListener('click', function () {
      if (confirm('¬øDeseas eliminar esta tarea?')) {
        const li = this.closest('li');
        if (li) li.remove();
      }
    });
  });
</script>
  <script>
    const form = document.querySelector('form');
    const camaSelect = document.getElementById('cama');
    const imagenInput = document.getElementById('imagen');
    const labInput = document.getElementById('lab');
    const interconsultaInput = document.getElementById('interconsulta');
    const otroTextarea = document.getElementById('otro');
    // Reutilizamos el select ya definido arriba
    // const accionSelect = document.getElementById('accion');

// Helper to determine if "Acumulado" is selected (tab-button active)
function isAcumuladoSelected() {
  const activeTab = document.querySelector('.tab-button.active');
  return activeTab && (activeTab.dataset.camaId === 'acumulado');
}

form.addEventListener("submit", function(event) {
  event.preventDefault();

  const camaSelect = document.getElementById("cama");
  const tareaInput = document.getElementById("otro");
  const camaActual = camaSelect.value;

  // Procede con la creaci√≥n de la tarea como ya est√© implementado
  const camaId = camaSelect.value;
  if (!camaId) return alert("Seleccione una cama para a√±adir tarea.");

  // Leer nombres de cama personalizados desde localStorage
  let tareasData = JSON.parse(localStorage.getItem('tareas') || '{}');
  const nombresCamas = tareasData['_nombresCamas'] || {};
  // Nombre mostrado para esta camaId
  let nombreCama = nombresCamas[camaId] || `CAMA ${camaId}`;
  // Normalizar para comparaci√≥n
  const normalize = str => (str || '').trim().toUpperCase();

  let nuevaTarea = '';
  if (accionSelect.value) {
    if (accionSelect.value === 'alta') nuevaTarea = 'Alta m√©dica';
    else if (accionSelect.value === 'hc') nuevaTarea = 'Realizar Historia Cl√≠nica';
    else if (accionSelect.value === 'evolucionar') nuevaTarea = 'Evolucionar paciente';
  }
  if (imagenInput.value.trim()) nuevaTarea += (nuevaTarea ? ' + ' : '') + `Imagen: ${imagenInput.value.trim()}`;
  if (labInput.value.trim()) nuevaTarea += (nuevaTarea ? ' + ' : '') + `Lab: ${labInput.value.trim()}`;
  if (interconsultaInput.value.trim()) nuevaTarea += (nuevaTarea ? ' + ' : '') + `IC: ${interconsultaInput.value.trim()}`;
  if (otroTextarea.value.trim()) nuevaTarea += (nuevaTarea ? ' + ' : '') + otroTextarea.value.trim();
  if (!nuevaTarea) return alert("Debe ingresar al menos un tipo de tarea.");

  // Buscar el <h3> correspondiente y su siguiente <ul> usando nombre actualizado
  let ul = null;
  document.querySelectorAll('h3').forEach(h3 => {
    // Usar el span con data-cama-id si existe
    const span = h3.querySelector('[data-cama-id]');
    let h3Nombre = span ? span.textContent : h3.textContent;
    if (normalize(h3Nombre) === normalize(nombreCama)) {
      ul = h3.nextElementSibling;
    }
  });
  if (!ul) return alert('No se encontr√≥ la cama seleccionada.');

  const li = document.createElement('li');
  li.style.display = 'flex';
  li.style.justifyContent = 'space-between';
  li.style.alignItems = 'flex-start';
  const numChecks = (accionSelect.value === 'alta' || accionSelect.value === 'hc' || accionSelect.value === 'evolucionar') ? 1 : 3;
  let checksHTML = '';
  for (let i = 0; i < numChecks; i++) {
    checksHTML += '<input type="checkbox" /> ';
  }
  // Cambiar el orden: texto primero, luego los checkboxes
  li.innerHTML = `
    <span style="max-width: 70%; margin-left: -14px;">${nuevaTarea}</span>
    <div class="task-checkboxes">
      <span class="edit-task" title="Editar tarea">‚úèÔ∏è</span>
      <span class="delete-task" title="Eliminar tarea">üóëÔ∏è</span>
      ${checksHTML}
    </div>
  `;
  ul.appendChild(li);
  // Agregar listeners a los checkboxes para guardarTareas
  li.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', guardarTareas);
  });
  guardarTareas();

  li.querySelector('.delete-task').addEventListener('click', function () {
    if (confirm('¬øDeseas eliminar esta tarea?')) {
      li.remove();
      guardarTareas();
    }
  });

  // Edit task logic
  li.querySelector('.edit-task').addEventListener('click', function () {
    const span = li.querySelector('span');
    const originalText = span.textContent.replace(' ‚úÖ', '').trim();
    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.style.width = '100%';
    input.style.marginLeft = '-14px';
    span.replaceWith(input);
    input.focus();

    const saveEdit = () => {
      const newSpan = document.createElement('span');
      newSpan.style.maxWidth = '70%';
      newSpan.style.marginLeft = '-14px';
      newSpan.textContent = input.value.trim();
      if ([...li.querySelectorAll('input[type="checkbox"]')].every(c => c.checked)) {
        newSpan.classList.add('completed-task');
        newSpan.innerHTML += ' ‚úÖ';
      }
      input.replaceWith(newSpan);
      guardarTareas();
    };

    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveEdit();
      }
    });
  });

  // Resetear el campo de tarea solamente
  tareaInput.value = "";

  // --- Dropdown logic for camaSelect ---
  // Remove the old camaSelect.value = "" logic
  // Instead, apply the dropdown lock/unlock logic:
  if (!isAcumuladoSelected()) {
    // Lock dropdown to current bed and disable
    camaSelect.value = camaSeleccionadaActual;
    camaSelect.disabled = true;
  } else {
    camaSelect.value = "";
    camaSelect.disabled = false;
  }

  // Limpiar otros campos del formulario si es necesario
  imagenInput.value = "";
  labInput.value = "";
  interconsultaInput.value = "";
  otroTextarea.value = "";
  alertaDropdown.style.display = 'none';
  usarAlertaDropdown.value = 'no';
  accionSelect.value = '';
  accionSelect.dispatchEvent(new Event('change'));

  // --- NUEVO: Volver a renderizar tareas filtradas y asignar listeners de checkboxes ---
  if (typeof renderFilteredTasks === "function" && camaSeleccionadaActual) {
    renderFilteredTasks(camaSeleccionadaActual);
  }
  if (typeof assignCheckboxListeners === "function") {
    assignCheckboxListeners();
  }
});

// --- NUEVO: Funci√≥n global para asignar listeners a los checkboxes de la vista filtrada ---
function assignCheckboxListeners() {
  const checkboxes = document.querySelectorAll('.filtered-task .task-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      const taskId = this.getAttribute('data-id');
      const checkboxType = this.getAttribute('data-type');
      updateCheckboxState(taskId, checkboxType, this.checked);
      renderAccumulatedTasks && renderAccumulatedTasks();
      renderFilteredTasks(currentBedNumber || camaSeleccionadaActual);
    });
  });
}

    function guardarTareas() {
      const datos = {};
      // Map camaId -> nombre actualizado
      const nombresCamas = {};
      document.querySelectorAll('[data-cama-id]').forEach(el => {
        const id = el.dataset.camaId;
        if (id) nombresCamas[id] = el.textContent.trim();
      });
      document.querySelectorAll('h3').forEach(h3 => {
        // Usar el span con data-cama-id para obtener el nombre de la cama
        const span = h3.querySelector('[data-cama-id]');
        let camaId = span ? span.dataset.camaId : null;
        let camaNombre = span ? span.textContent.trim() : h3.textContent.trim();
        // Si tiene camaId, usar el nombre actualizado de nombresCamas
        if (camaId && nombresCamas[camaId]) {
          camaNombre = nombresCamas[camaId];
        }
        const ul = h3.nextElementSibling;
        if (ul) {
          datos[camaNombre] = [];
          ul.querySelectorAll('li').forEach(li => {
            const tareaSpan = li.querySelector('span');
            const checks = [...li.querySelectorAll('input[type="checkbox"]')].map(c => c.checked);
            datos[camaNombre].push({ texto: tareaSpan.textContent.trim(), checks });

            // Aplicar estilo si todas las casillas est√°n marcadas
            const allChecked = checks.every(c => c === true);
            if (allChecked) {
              tareaSpan.classList.add('completed-task');
              if (!tareaSpan.innerHTML.includes('‚úÖ')) {
                tareaSpan.innerHTML += ' ‚úÖ';
              }
            } else {
              tareaSpan.classList.remove('completed-task');
              tareaSpan.innerHTML = tareaSpan.innerHTML.replace(' ‚úÖ', '');
            }
          });
        }
      });
      // Guardar los nombres de cama personalizados
      datos['_nombresCamas'] = nombresCamas;
      localStorage.setItem('tareas', JSON.stringify(datos));
      // Unificar renderizado tras guardar
      renderTareas();
    }

    function cargarTareasGuardadas() {
      renderTareas();
    }

    window.addEventListener('load', cargarTareasGuardadas);
    window.addEventListener('beforeunload', guardarTareas);

    // --- NUEVAS FUNCIONES DE RENDER UNIFICADO ---
    // Crea un div visual de tarea para el panel acumulado y para camas
    function crearElementoTarea(tarea, index) {
      const tareaDiv = document.createElement("div");
      tareaDiv.className = "tarea";
      const texto = document.createElement("span");
      texto.textContent = tarea.texto;
      const checksContainer = document.createElement("span");
      checksContainer.style.marginLeft = "10px";
      for (let i = 0; i < (tarea.checks ? tarea.checks.length : 3); i++) {
        const check = document.createElement("input");
        check.type = "checkbox";
        check.checked = tarea.checks && tarea.checks[i];
        check.disabled = true;
        checksContainer.appendChild(check);
      }
      if (tarea.checks?.every(c => c)) {
        tareaDiv.classList.add("completado");
        texto.innerHTML += " ‚úÖ";
      }
      tareaDiv.appendChild(texto);
      tareaDiv.appendChild(checksContainer);
      return tareaDiv;
    }

    // Renderiza todas las tareas acumuladas y por cama
    function renderTareas() {
      // Panel acumulado
      const tareasData = JSON.parse(localStorage.getItem("tareas")) || {};
      // Limpiar todos los UL de camas acumuladas
      document.querySelectorAll('h3').forEach(h3 => {
        const ul = h3.nextElementSibling;
        if (ul) ul.innerHTML = '';
      });
      // Restaurar los nombres de cama personalizados si existen
      const nombresCamas = tareasData['_nombresCamas'] || {};
      for (const camaId in nombresCamas) {
        const formatted = nombresCamas[camaId];
        document.querySelectorAll(`[data-cama-id="${camaId}"]`).forEach(elm => elm.textContent = formatted);
        const option = document.querySelector(`#cama option[value="${camaId}"]`);
        if (option) option.textContent = formatted;
      }
      // Helper para normalizar
      const normalize = str => (str || '').trim().toUpperCase();
      for (const cama in tareasData) {
        if (cama === '_nombresCamas') continue;
        // Buscar el h3 cuyo nombre (por span data-cama-id o text) coincide con cama (normalizado)
        let h3 = null;
        for (const h of document.querySelectorAll('h3')) {
          const s = h.querySelector('[data-cama-id]');
          let h3Nombre = s ? s.textContent.trim() : h.textContent.trim();
          if (normalize(h3Nombre) === normalize(cama)) {
            h3 = h;
            break;
          }
        }
        if (!h3) continue;
        const ul = h3.nextElementSibling;
        tareasData[cama].forEach((tarea, idx) => {
          const li = document.createElement('li');
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'flex-start';
          // Crear checkboxes
          let checksHTML = '';
          for (let i = 0; i < (tarea.checks ? tarea.checks.length : 3); i++) {
            checksHTML += `<input type="checkbox" ${tarea.checks && tarea.checks[i] ? 'checked' : ''}/> `;
          }
          // Cambiar el orden: texto primero, luego los checkboxes
          li.innerHTML = `
            <span style="max-width: 70%; margin-left: -14px;">${tarea.texto}</span>
            <div class="task-checkboxes">
              <span class="edit-task" title="Editar tarea">‚úèÔ∏è</span>
              <span class="delete-task" title="Eliminar tarea">üóëÔ∏è</span>
              ${checksHTML}
            </div>
          `;
          const span = li.querySelector('span');
          const allChecked = tarea.checks && tarea.checks.every(c => c === true);
          if (allChecked) {
            span.classList.add('completed-task');
            if (!span.innerHTML.includes('‚úÖ')) {
              span.innerHTML += ' ‚úÖ';
            }
          } else {
            span.classList.remove('completed-task');
            span.innerHTML = span.innerHTML.replace(' ‚úÖ', '');
          }
          ul.appendChild(li);
          li.querySelector('.delete-task').addEventListener('click', function () {
            if (confirm('¬øDeseas eliminar esta tarea?')) {
              li.remove();
              guardarTareas();
            }
          });
          li.querySelectorAll('input[type="checkbox"]').forEach((cb, idx2) => {
            cb.addEventListener('change', function() {
              // Actualizar el check correspondiente en tarea
              tarea.checks[idx2] = cb.checked;
              guardarTareas();
            });
          });
          // Edit task logic
          li.querySelector('.edit-task').addEventListener('click', function () {
            const span = li.querySelector('span');
            const originalText = span.textContent.replace(' ‚úÖ', '').trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.style.width = '100%';
            input.style.marginLeft = '-14px';
            span.replaceWith(input);
            input.focus();
            const saveEdit = () => {
              const newSpan = document.createElement('span');
              newSpan.style.maxWidth = '70%';
              newSpan.style.marginLeft = '-14px';
              newSpan.textContent = input.value.trim();
              if ([...li.querySelectorAll('input[type="checkbox"]')].every(c => c.checked)) {
                newSpan.classList.add('completed-task');
                newSpan.innerHTML += ' ‚úÖ';
              }
              input.replaceWith(newSpan);
              // Actualizar el texto de la tarea
              tarea.texto = input.value.trim();
              guardarTareas();
            };
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                saveEdit();
              }
            });
          });
        });
      }
      // Renderizar tareas por cama en ventanas de cama
      renderTareasPorCama();
    }

    // Renderiza tareas filtradas en cada ventana de cama individual
    function renderTareasPorCama() {
      const tareasData = JSON.parse(localStorage.getItem("tareas")) || {};
      const camas = document.querySelectorAll(".bed-panel.cama-panel");
      // Si no hay paneles .cama-panel, intentar .cama-window (legacy)
      if (camas.length === 0) return;
      camas.forEach(camaDiv => {
        let camaId = camaDiv.getAttribute('data-bed');
        // camaId puede ser 'CAMA 1', etc. Obtener id num√©rico
        let idNum = null;
        const m = camaId && camaId.match(/\d+/);
        if (m) idNum = m[0];
        // Buscar contenedor de tareas filtradas
        const contenedor = camaDiv.querySelector("#filtered-task-container");
        if (!contenedor) return;
        contenedor.innerHTML = "";
        // Buscar nombre personalizado
        const nombresCamas = tareasData['_nombresCamas'] || {};
        let nombreCama = nombresCamas[idNum] || `CAMA ${idNum}`;
        const tareasCama = tareasData[nombreCama] || [];
        tareasCama.forEach((tarea, index) => {
          const tareaDiv = crearElementoTarea(tarea, index);
          contenedor.appendChild(tareaDiv);
        });
      });
    }
    // Hacer editable el n√∫mero de cama con doble clic, excepto "Acumulado"
    function setupCamaNameEditing() {
      document.querySelectorAll('[data-cama-id]').forEach(el => {
        // No permitir editar el bot√≥n "Acumulado"
        if (
          (el.id && el.id === 'acumulado-button') ||
          (el.dataset.camaId && el.dataset.camaId.toLowerCase() === 'acumulado')
        ) return;
        // Remove any previous dblclick event to avoid multiple handlers
        el.removeEventListener('dblclick', el._camaEditHandler);
        // Store the handler so we can remove it later if needed
        el._camaEditHandler = function(event) {
          // Prevent double prompt by stopping propagation if needed
          event.stopPropagation();
          const camaId = el.dataset.camaId;
          // Guardar el nombre original antes de cualquier cambio
          el.setAttribute("data-prev-name", el.textContent.trim());
          const originalName = el.textContent.trim();
          const newNumber = prompt(`Editar n√∫mero de cama ${camaId}`, originalName.match(/\d{1,3}/)?.[0] || '');
          if (!newNumber || isNaN(newNumber) || newNumber < 1 || newNumber > 999) return;

          const formatted = `CAMA ${parseInt(newNumber)}`;

          // Validaci√≥n: prevenir duplicaci√≥n de n√∫mero de cama
          let tareasData = JSON.parse(localStorage.getItem('tareas') || '{}');
          const nombresCamas = tareasData['_nombresCamas'] || {};
          const normalize = str => (str || '').trim().toUpperCase();
          const existingNumbers = Object.entries(nombresCamas)
            .filter(([id, name]) => id !== camaId && normalize(name) !== 'ACUMULADO')
            .map(([id, name]) => normalize(name));
          for (let i = 1; i <= 20; i++) {
            const idStr = String(i);
            if (!nombresCamas[idStr] && idStr !== camaId) {
              existingNumbers.push(normalize(`CAMA ${i}`));
            }
          }
          if (existingNumbers.includes(normalize(formatted))) {
            alert("Ese n√∫mero de cama ya existe. Usa otro distinto.");
            el.textContent = originalName;
            return;
          }

          // Actualizar todos los elementos con ese camaId
          document.querySelectorAll(`[data-cama-id="${camaId}"]`).forEach(elm => elm.textContent = formatted);

          // Actualizar tambi√©n el select de a√±adir tarea
          const option = document.querySelector(`#cama option[value="${camaId}"]`);
          if (option) option.textContent = formatted;

          // Actualizar las tareas en localStorage para reflejar el cambio de nombre de cama
          let oldNombre = null;
          for (const key in tareasData) {
            if (key !== '_nombresCamas' && normalize(key) === normalize(originalName)) {
              oldNombre = key;
              break;
            }
          }
          if (oldNombre && oldNombre !== formatted) {
            tareasData[formatted] = tareasData[oldNombre];
            delete tareasData[oldNombre];
          }
          nombresCamas[camaId] = formatted;
          tareasData['_nombresCamas'] = nombresCamas;
          localStorage.setItem('tareas', JSON.stringify(tareasData));

          // --- NUEVO: Actualizar panel individual si est√° visible y data-bed ---
          const individualPanel = document.querySelector(`.bed-panel[data-bed]`);
          if (individualPanel && individualPanel.style.display !== 'none') {
            const bedPanelTitle = individualPanel.querySelector('.bed-panel-title');
            if (bedPanelTitle) bedPanelTitle.textContent = formatted;
            individualPanel.setAttribute('data-bed', formatted);
          }
          // --- FIN NUEVO ---

          // Recargar la UI de tareas con los nuevos nombres
          cargarTareasGuardadas();
          // Actualizar la vista individual de cama si corresponde (para reflejar nombre y fecha actualizados)
          updateBedView && updateBedView(camaId);
    // Nueva funci√≥n: actualizar la vista individual de cama (t√≠tulo y clinical boxes)
    function updateBedView(bedId) {
      const today = new Date();
      // Obtener nombres personalizados
      let tareasData = JSON.parse(localStorage.getItem('tareas') || '{}');
      const nombresCamas = tareasData['_nombresCamas'] || {};
      let nombreCama = nombresCamas[bedId] || `CAMA ${bedId}`;
      // Actualizar el t√≠tulo y el atributo data-bed del panel individual
      const camaPanel = document.querySelector('.bed-panel.cama-panel');
      if (camaPanel) {
        camaPanel.setAttribute('data-bed', nombreCama);
        const title = camaPanel.querySelector('.bed-panel-title');
        if (title) title.textContent = `Plan ${nombreCama} ‚Ä¢ ${today.toLocaleDateString('es-PE')}`;
      }
      // Actualizar clinical boxes
      updateClinicalBoxes(bedId);
    }
        };
        el.addEventListener('dblclick', el._camaEditHandler);
      });
    }

    window.addEventListener('load', setupCamaNameEditing);
  </script>
  <script>
    // Recuperar nombres almacenados
    let storedNames = JSON.parse(localStorage.getItem('bedNames')) || {};

    // Eliminar cualquier nombre mal guardado del bot√≥n "acumulado"
    if (storedNames['acumulado']) {
      delete storedNames['acumulado'];
      localStorage.setItem('bedNames', JSON.stringify(storedNames));
    }

    // Aplicar nombres a los botones
    const bedButtons = document.querySelectorAll('.bed-button, [data-cama-id]');
    bedButtons.forEach(button => {
      const bedId = button.getAttribute('data-cama-id') || button.getAttribute('data-bed-id');
      if (bedId === 'acumulado') {
        button.textContent = 'ACUMULADO'; // Fuerza
      } else if (storedNames[bedId]) {
        button.textContent = storedNames[bedId];
      }
    });

    // Gesti√≥n de navegaci√≥n entre vistas acumulado y cama individual
    document.querySelectorAll('.tab-button').forEach(btn => {
      // Remove any previous dblclick event to prevent duplicates
      btn.removeEventListener('dblclick', btn._tabDblClickHandler);
      btn._tabDblClickHandler = function(event) {
        // Prevent double prompt by stopping propagation
        event.stopPropagation();
        // Edici√≥n de nombre de cama desde men√∫ horizontal (tab-button)
        const camaId = btn.dataset.camaId;
        if (!camaId || camaId === 'acumulado') return;
        // Guardar el nombre original antes de cualquier cambio
        btn.setAttribute("data-prev-name", btn.textContent.trim());
        const originalName = btn.textContent.trim();
        const newNumber = prompt(`Editar n√∫mero de cama ${camaId}`, originalName.match(/\d{1,3}/)?.[0] || '');
        if (!newNumber || isNaN(newNumber) || newNumber < 1 || newNumber > 999) return;
        const formatted = `CAMA ${parseInt(newNumber)}`;
        // Validaci√≥n: prevenir duplicaci√≥n de n√∫mero de cama
        let tareasData = JSON.parse(localStorage.getItem('tareas') || '{}');
        const nombresCamas = tareasData['_nombresCamas'] || {};
        const normalize = str => (str || '').trim().toUpperCase();
        const existingNumbers = Object.entries(nombresCamas)
          .filter(([id, name]) => id !== camaId && normalize(name) !== 'ACUMULADO')
          .map(([id, name]) => normalize(name));
        for (let i = 1; i <= 20; i++) {
          const idStr = String(i);
          if (!nombresCamas[idStr] && idStr !== camaId) {
            existingNumbers.push(normalize(`CAMA ${i}`));
          }
        }
        if (existingNumbers.includes(normalize(formatted))) {
          alert("Ese n√∫mero de cama ya existe. Usa otro distinto.");
          btn.textContent = originalName;
          return;
        }
        // Actualizar todos los elementos con ese camaId
        document.querySelectorAll(`[data-cama-id="${camaId}"]`).forEach(elm => elm.textContent = formatted);
        // Actualizar tambi√©n el select de a√±adir tarea
        const option = document.querySelector(`#cama option[value="${camaId}"]`);
        if (option) option.textContent = formatted;
        // Actualizar las tareas en localStorage para reflejar el cambio de nombre de cama
        let oldNombre = null;
        for (const key in tareasData) {
          if (key !== '_nombresCamas' && normalize(key) === normalize(originalName)) {
            oldNombre = key;
            break;
          }
        }
        if (oldNombre && oldNombre !== formatted) {
          tareasData[formatted] = tareasData[oldNombre];
          delete tareasData[oldNombre];
        }
        nombresCamas[camaId] = formatted;
        tareasData['_nombresCamas'] = nombresCamas;
        localStorage.setItem('tareas', JSON.stringify(tareasData));
        // Actualizar panel individual si est√° visible y data-bed
        const individualPanel = document.querySelector(`.bed-panel[data-bed]`);
        if (individualPanel && individualPanel.style.display !== 'none') {
          const bedPanelTitle = individualPanel.querySelector('.bed-panel-title');
          if (bedPanelTitle) bedPanelTitle.textContent = formatted;
          individualPanel.setAttribute('data-bed', formatted);
        }
        cargarTareasGuardadas();
      };
      btn.addEventListener('dblclick', btn._tabDblClickHandler);
      btn.addEventListener('click', () => {
        const camaId = btn.dataset.camaId;
        // Manejo de clases activas
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const camaDropdown = document.getElementById("cama");
        if (camaId === 'acumulado') {
          document.getElementById('acumulado-view').style.display = 'block';
          document.getElementById('cama-view').style.display = 'none';
          // Unlock dropdown when switching back to Acumulado
          if (camaDropdown) {
            camaDropdown.disabled = false;
          }
          currentCama = null;
          camaSeleccionadaActual = null;
          // On initial load of Acumulado, unlock dropdown
          if (camaDropdown) {
            camaDropdown.value = "";
            camaDropdown.disabled = false;
          }
        } else {
          document.getElementById('acumulado-view').style.display = 'none';
          document.getElementById('cama-view').style.display = 'block';
          const today = new Date();
          // Obtener nombres personalizados
          let tareasData = JSON.parse(localStorage.getItem('tareas') || '{}');
          const nombresCamas = tareasData['_nombresCamas'] || {};
          let nombreCama = nombresCamas[camaId] || `CAMA ${camaId}`;
          // Actualizar el t√≠tulo y el atributo data-bed del panel individual
          const camaPanel = document.querySelector('.bed-panel.cama-panel');
          if (camaPanel) {
            camaPanel.setAttribute('data-bed', nombreCama);
            const title = camaPanel.querySelector('.bed-panel-title');
            if (title) title.textContent = `Plan ${nombreCama} ‚Ä¢ ${today.toLocaleDateString('es-PE')}`;
          }
          // Set and lock the dropdown to current bed
          if (camaDropdown) {
            camaDropdown.value = camaId;
            camaDropdown.disabled = true;
          }
          // Update global currentCama variable
          currentCama = camaId;
          camaSeleccionadaActual = camaId;
          // Lock the dropdown on initial load of the bed window
          if (camaDropdown) {
            if (!isAcumuladoSelected()) {
              camaDropdown.value = camaSeleccionadaActual;
              camaDropdown.disabled = true;
            } else {
              camaDropdown.disabled = false;
            }
          }
          // Llamar a la funci√≥n para actualizar las clinical boxes:
          showBedView(camaId);
          // Llamar a renderFilteredTasks para mostrar tareas filtradas en la vista individual
          renderFilteredTasks(camaId);
        }
      });
    });
    // Funci√≥n para actualizar las clinical boxes (guardar y recuperar por cama)
    function updateClinicalBoxes(bedId) {
      const types = ['history', 'diagnosis', 'evolution'];
      types.forEach(type => {
        const key = `${bedId}_clinical_${type}`;
        const textarea = document.querySelector(`textarea[data-type="${type}"]`);
        if (textarea) {
          textarea.value = localStorage.getItem(key) || '';
          textarea.oninput = () => {
            localStorage.setItem(key, textarea.value);
          };
        }
      });
    }

    // Funci√≥n para mostrar la vista de cama y actualizar las clinical boxes
    function showBedView(bedId) {
      // Asume que ya se ha mostrado el panel individual y actualizado el t√≠tulo
      updateClinicalBoxes(bedId);
    }
  </script>
</body>
  <footer style="text-align: center; margin-top: 30px; padding: 12px; font-size: 14px; background-color: #f5f5f5; border-top: 1px solid #ccc;">
    Creado por Javier A. Lama Agurto ‚Äì
    <a href="https://www.instagram.com/javier.lama/" target="_blank" style="color: #c13584; text-decoration: none;">Instagram</a> ‚Äì
    <a href="https://www.linkedin.com/in/javier-augusto-lama-agurto-459035203" target="_blank" style="color: #0a66c2; text-decoration: none;">LinkedIn</a>
  </footer>
</body>
</html>

  <script>
    // --- NUEVO: Renderizado condicional del bot√≥n borrar todas las tareas ---
    function renderDeleteAllButton() {
      const deleteAllContainer = document.getElementById('delete-all-container');
      if (!deleteAllContainer) return;
      // Solo mostrar si la vista acumulada est√° visible
      const acumuladoView = document.getElementById('acumulado-view');
      if (acumuladoView && acumuladoView.style.display !== 'none') {
        deleteAllContainer.innerHTML = `
          <button id="borrar-todas-tareas" class="delete-all-tasks-btn" style="background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer;">
            üóëÔ∏è Borrar TODAS las tareas
          </button>
        `;
        // Asignar el listener al bot√≥n
        const btn = document.getElementById('borrar-todas-tareas');
        if (btn) {
          btn.onclick = function () {
            const confirmacion = confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas borrar TODAS las tareas de TODAS las camas?");
            if (!confirmacion) return;
            localStorage.setItem("tareas", JSON.stringify([]));
            if (typeof renderizarPanelAcumulado === "function") {
              renderizarPanelAcumulado();
            }
            if (typeof renderizarVentanasCamas === "function") {
              renderizarVentanasCamas();
            }
            if (typeof renderTareas === "function") {
              renderTareas();
            }
            if (typeof renderFilteredTasks === "function" && typeof camaSeleccionadaActual !== "undefined" && camaSeleccionadaActual) {
              renderFilteredTasks(camaSeleccionadaActual);
            }
            renderDeleteAllButton();
          };
        }
      } else {
        deleteAllContainer.innerHTML = '';
      }
    }
    // Llamar al renderizador de bot√≥n al cargar y al cambiar de pesta√±a
    window.addEventListener('DOMContentLoaded', renderDeleteAllButton);
    // Interceptar clicks en tabs para volver a renderizar el bot√≥n
    document.addEventListener('click', function(e) {
      if (e.target.classList && e.target.classList.contains('tab-button')) {
        setTimeout(renderDeleteAllButton, 10);
      }
    });
  </script>